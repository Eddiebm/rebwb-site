<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Library & Goods</title>
    <meta name="robots" content="noindex">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="js/analytics.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/" class="text-xl font-bold text-white">REBWB</a>
                <a href="library.html" class="text-gray-300 hover:text-white transition text-sm">Back to Library</a>
            </div>
        </div>
    </nav>

    <section class="py-20 md:py-28">
        <div class="max-w-lg mx-auto px-6">
            <h1 class="text-2xl font-semibold text-white mb-2">Library & Goods</h1>
            <p class="text-gray-500 mb-12">Selected items from the Real Estate Without Bullsh*tâ„¢ system.</p>
            
            <div id="cartItems" class="space-y-4 mb-8 border-b border-gray-800 pb-8"></div>

            <div id="emptyCart" class="hidden text-center py-12">
                <p class="text-gray-500 mb-6">Your cart is empty.</p>
                <a href="library.html" class="text-gray-400 hover:text-white transition">Return to Library & Goods</a>
            </div>

            <div id="cartTotal" class="flex justify-between items-center mb-8">
                <span class="text-gray-400">Total</span>
                <span id="totalAmount" class="text-xl text-white font-medium">$0</span>
            </div>

            <div id="checkoutForm">
                <div class="space-y-6 mb-8">
                    <div>
                        <label class="block text-sm text-gray-500 mb-2">Email</label>
                        <input type="email" id="email" class="w-full bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:outline-none focus:border-gray-500" placeholder="you@example.com">
                    </div>
                </div>

                <p class="text-gray-500 text-sm leading-relaxed mb-8">
                    You are purchasing a physical or written artifact.<br>
                    This does not include course access, software features, or system upgrades.
                </p>

                <button id="checkoutBtn" onclick="checkout()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg font-medium transition">
                    Complete Purchase
                </button>
                
                <p id="errorMsg" class="text-red-500 text-sm mt-4 hidden"></p>
            </div>
        </div>
    </section>

    <footer class="py-12 border-t border-gray-800">
        <div class="max-w-lg mx-auto px-6 text-center">
            <p class="text-xs text-gray-600">
                Nothing here replaces judgment.<br>
                That remains your responsibility.
            </p>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://nzutywxvzcrjopvyayml.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56dXR5d3h2emNyam9wdnlheW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzIzMTEsImV4cCI6MjA4NDIwODMxMX0.C4UdwnQEebRwUrdbiNeQN2Wl4nQFeCLVAmzhDI8LKWI';
        
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('rebwb_cart') || '[]');
            const container = document.getElementById('cartItems');
            const emptyState = document.getElementById('emptyCart');
            const checkoutForm = document.getElementById('checkoutForm');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                container.classList.add('hidden');
                cartTotal.classList.add('hidden');
                checkoutForm.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            let html = '';
            let total = 0;
            
            cart.forEach((item, index) => {
                html += `
                    <div class="flex justify-between items-start py-4 border-b border-gray-800">
                        <p class="text-white">${item.name}</p>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-400">$${item.price}</span>
                            <button onclick="removeItem(${index})" class="text-gray-600 hover:text-gray-400 transition text-sm">Remove</button>
                        </div>
                    </div>
                `;
                total += item.price;
            });
            
            container.innerHTML = html;
            document.getElementById('totalAmount').textContent = '$' + total;
        }
        
        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('rebwb_cart') || '[]');
            cart.splice(index, 1);
            localStorage.setItem('rebwb_cart', JSON.stringify(cart));
            renderCart();
        }
        
        async function checkout() {
            const email = document.getElementById('email').value;
            const cart = JSON.parse(localStorage.getItem('rebwb_cart') || '[]');
            const btn = document.getElementById('checkoutBtn');
            const errorMsg = document.getElementById('errorMsg');
            
            if (!email) {
                errorMsg.textContent = 'Please enter your email.';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            if (cart.length === 0) return;
            
            btn.textContent = 'Processing...';
            btn.disabled = true;
            errorMsg.classList.add('hidden');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/create-checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify({
                        items: cart,
                        email: email,
                        success_url: window.location.origin + '/checkout-success.html',
                        cancel_url: window.location.origin + '/checkout.html',
                    }),
                });
                
                const data = await response.json();
                
                if (data.url) {
                    localStorage.removeItem('rebwb_cart');
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || 'Checkout failed. Please try again.');
                }
            } catch (error) {
                errorMsg.textContent = error.message || 'Something went wrong. Please try again.';
                errorMsg.classList.remove('hidden');
                btn.textContent = 'Complete Purchase';
                btn.disabled = false;
            }
        }
        
        renderCart();
    </script>
</body>
</html>
