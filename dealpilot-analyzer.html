<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DealPilot Analyzer — Go / No-Go Deal Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-white">REBWB</a>
                </div>
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="index.html" class="text-gray-300 hover:text-white transition">Home</a>
                    <a href="course.html" class="text-gray-300 hover:text-white transition">Course</a>
                    <a href="dealpilot.html" class="text-white font-semibold">DealPilot</a>
                    <a href="templates.html" class="text-gray-300 hover:text-white transition">Templates</a>
                    <a href="tools.html" class="text-gray-300 hover:text-white transition">Tools</a>
                    <a href="faq.html" class="text-gray-300 hover:text-white transition">FAQ</a>
                    <a href="about.html" class="text-gray-300 hover:text-white transition">About</a>
                    <button onclick="signOut()" class="text-gray-300 hover:text-white transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    <script src="js/auth.js"></script>
    <script>requireAuth();</script>

    <!-- Deal Analyzer -->
    <section class="py-12 bg-gray-900">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Go / No-Go Deal Builder</h1>
                <p class="text-gray-400">Conservative underwriting with no rosy assumptions</p>
            </div>
            
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <!-- Step Indicators -->
                <div class="flex flex-wrap gap-2 justify-center mb-8 text-sm">
                    <button class="step-btn active px-3 py-2 rounded bg-blue-600 text-white" data-step="1">1. Basics</button>
                    <button class="step-btn px-3 py-2 rounded bg-gray-700 text-gray-400" data-step="2">2. Acquisition</button>
                    <button class="step-btn px-3 py-2 rounded bg-gray-700 text-gray-400" data-step="3">3. Financing</button>
                    <button class="step-btn px-3 py-2 rounded bg-gray-700 text-gray-400" data-step="4">4. Income</button>
                    <button class="step-btn px-3 py-2 rounded bg-gray-700 text-gray-400" data-step="5">5. Expenses</button>
                    <button class="step-btn px-3 py-2 rounded bg-gray-700 text-gray-400" data-step="6">6. Rules</button>
                </div>

                <!-- Step 1: Basics -->
                <div class="step-content" id="step1">
                    <h3 class="text-xl font-bold mb-4">Step 1: Deal Basics</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Deal Name</label>
                            <input type="text" id="dealName" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" placeholder="123 Main St">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">City, State</label>
                            <input type="text" id="location" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" placeholder="Austin, TX">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Acquisition -->
                <div class="step-content hidden" id="step2">
                    <h3 class="text-xl font-bold mb-4">Step 2: Acquisition</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Purchase Price ($)</label>
                            <input type="number" id="purchasePrice" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="250000">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Closing Costs ($)</label>
                            <input type="number" id="closingCosts" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="5000">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Rehab Budget ($)</label>
                            <input type="number" id="rehabBudget" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="0">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Financing -->
                <div class="step-content hidden" id="step3">
                    <h3 class="text-xl font-bold mb-4">Step 3: Financing</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Down Payment (%)</label>
                            <input type="number" id="downPayment" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="20">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Interest Rate (%)</label>
                            <input type="number" id="interestRate" step="0.1" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="7.0">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Loan Term (years)</label>
                            <select id="loanTerm" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white">
                                <option value="30">30 years</option>
                                <option value="15">15 years</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-gray-900 rounded border border-gray-700">
                        <p class="text-sm text-gray-400">Loan Amount: <span id="loanAmount" class="text-white font-bold">$200,000</span></p>
                        <p class="text-sm text-gray-400">Monthly P&I: <span id="monthlyPI" class="text-white font-bold">$1,331</span></p>
                    </div>
                </div>

                <!-- Step 4: Income -->
                <div class="step-content hidden" id="step4">
                    <h3 class="text-xl font-bold mb-4">Step 4: Income</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Monthly Rent ($)</label>
                            <input type="number" id="monthlyRent" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="2000">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Other Monthly Income ($)</label>
                            <input type="number" id="otherIncome" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="0">
                        </div>
                    </div>
                </div>

                <!-- Step 5: Expenses -->
                <div class="step-content hidden" id="step5">
                    <h3 class="text-xl font-bold mb-4">Step 5: Operating Expenses</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Property Taxes (annual $)</label>
                            <input type="number" id="propertyTaxes" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="3000">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Insurance (annual $)</label>
                            <input type="number" id="insurance" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="1500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Vacancy (%)</label>
                            <input type="number" id="vacancy" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="6">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Management (%)</label>
                            <input type="number" id="management" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="8">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Maintenance (%)</label>
                            <input type="number" id="maintenance" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="6">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">CapEx (%)</label>
                            <input type="number" id="capex" class="w-full bg-gray-900 border border-gray-600 rounded px-4 py-2 text-white" value="6">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Default values use conservative "Without Bullshit" assumptions.</p>
                </div>

                <!-- Step 6: Rules -->
                <div class="step-content hidden" id="step6">
                    <h3 class="text-xl font-bold mb-4">Step 6: Go / No-Go Rules</h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-red-400 font-bold mb-3">FAIL RULES (deal fails if violated)</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-400">Monthly cash flow ≥</span>
                                    <input type="number" id="ruleCashFlow" class="w-20 bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm" value="0">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-400">DSCR ≥</span>
                                    <input type="number" id="ruleDSCR" step="0.01" class="w-20 bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm" value="1.20">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-yellow-400 font-bold mb-3">WARN RULES (deal needs fixes)</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-400">Cash-on-cash ≥</span>
                                <input type="number" id="ruleCOC" class="w-20 bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm" value="8">
                                <span class="text-sm text-gray-400">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="flex justify-between mt-8">
                    <button id="prevBtn" class="hidden px-6 py-2 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition">Previous</button>
                    <div></div>
                    <button id="nextBtn" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Next</button>
                    <button id="analyzeBtn" class="hidden px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition font-bold">Analyze Deal</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Results -->
    <section id="results" class="py-12 bg-gray-800 hidden">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <div id="resultBadge" class="inline-block px-8 py-4 rounded-lg text-2xl font-bold mb-4"></div>
                <h2 class="text-2xl font-bold">Deal Analysis Results</h2>
            </div>

            <div id="reasonsList" class="mb-8"></div>

            <div class="grid md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <p class="text-sm text-gray-400">Monthly Cash Flow</p>
                    <p id="resCashFlow" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <p class="text-sm text-gray-400">DSCR</p>
                    <p id="resDSCR" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <p class="text-sm text-gray-400">Cash-on-Cash</p>
                    <p id="resCOC" class="text-2xl font-bold"></p>
                </div>
            </div>

            <div class="text-center">
                <button onclick="location.reload()" class="px-6 py-3 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition">Analyze Another Deal</button>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 border-t border-gray-700 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="font-bold text-white mb-1">REBWB</p>
            <p class="text-sm text-gray-400">Real Estate Without Bullshit</p>
        </div>
    </footer>

    <script>
        let currentStep = 1;
        const totalSteps = 6;

        document.querySelectorAll('.step-btn').forEach(btn => {
            btn.addEventListener('click', () => goToStep(parseInt(btn.dataset.step)));
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentStep < totalSteps) goToStep(currentStep + 1);
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentStep > 1) goToStep(currentStep - 1);
        });

        document.getElementById('analyzeBtn').addEventListener('click', analyzeDeal);

        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-content').forEach((el, i) => {
                el.classList.toggle('hidden', i !== step - 1);
            });
            document.querySelectorAll('.step-btn').forEach((btn, i) => {
                btn.classList.toggle('bg-blue-600', i === step - 1);
                btn.classList.toggle('text-white', i === step - 1);
                btn.classList.toggle('bg-gray-700', i !== step - 1);
                btn.classList.toggle('text-gray-400', i !== step - 1);
            });
            document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', step === totalSteps);
            document.getElementById('analyzeBtn').classList.toggle('hidden', step !== totalSteps);
            updateCalculations();
        }

        function updateCalculations() {
            const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const downPct = parseFloat(document.getElementById('downPayment').value) || 0;
            const rate = parseFloat(document.getElementById('interestRate').value) || 0;
            const term = parseInt(document.getElementById('loanTerm').value) || 30;

            const loanAmount = price * (1 - downPct / 100);
            const monthlyRate = rate / 100 / 12;
            const numPayments = term * 12;
            const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);

            document.getElementById('loanAmount').textContent = '$' + loanAmount.toLocaleString('en-US', {maximumFractionDigits: 0});
            document.getElementById('monthlyPI').textContent = '$' + (isNaN(monthlyPI) ? 0 : monthlyPI).toLocaleString('en-US', {maximumFractionDigits: 0});
        }

        document.querySelectorAll('#purchasePrice, #downPayment, #interestRate, #loanTerm').forEach(el => {
            el.addEventListener('input', updateCalculations);
        });

        function analyzeDeal() {
            const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const closing = parseFloat(document.getElementById('closingCosts').value) || 0;
            const rehab = parseFloat(document.getElementById('rehabBudget').value) || 0;
            const downPct = parseFloat(document.getElementById('downPayment').value) || 0;
            const rate = parseFloat(document.getElementById('interestRate').value) || 0;
            const term = parseInt(document.getElementById('loanTerm').value) || 30;
            const rent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            const taxes = parseFloat(document.getElementById('propertyTaxes').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const vacancyPct = parseFloat(document.getElementById('vacancy').value) || 0;
            const mgmtPct = parseFloat(document.getElementById('management').value) || 0;
            const maintPct = parseFloat(document.getElementById('maintenance').value) || 0;
            const capexPct = parseFloat(document.getElementById('capex').value) || 0;

            const loanAmount = price * (1 - downPct / 100);
            const monthlyRate = rate / 100 / 12;
            const numPayments = term * 12;
            const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);

            const grossIncome = rent + otherIncome;
            const effectiveIncome = grossIncome * (1 - vacancyPct / 100);
            const opexPct = mgmtPct + maintPct + capexPct;
            const opexDollar = effectiveIncome * (opexPct / 100) + (taxes + insurance) / 12;
            const noi = (effectiveIncome - opexDollar) * 12;
            const monthlyDebt = monthlyPI;
            const cashFlow = effectiveIncome - opexDollar - monthlyDebt;
            const totalCashIn = (price * downPct / 100) + closing + rehab;
            const annualCashFlow = cashFlow * 12;
            const coc = totalCashIn > 0 ? (annualCashFlow / totalCashIn) * 100 : 0;
            const dscr = monthlyDebt > 0 ? noi / 12 / monthlyDebt : 0;

            const ruleCashFlow = parseFloat(document.getElementById('ruleCashFlow').value);
            const ruleDSCR = parseFloat(document.getElementById('ruleDSCR').value);
            const ruleCOC = parseFloat(document.getElementById('ruleCOC').value);

            let fails = [];
            let warns = [];

            if (cashFlow < ruleCashFlow) fails.push(`Cash flow $${cashFlow.toFixed(0)} < $${ruleCashFlow} threshold`);
            if (dscr < ruleDSCR) fails.push(`DSCR ${dscr.toFixed(2)} < ${ruleDSCR} threshold`);
            if (coc < ruleCOC) warns.push(`Cash-on-cash ${coc.toFixed(1)}% < ${ruleCOC}% target`);

            document.getElementById('results').classList.remove('hidden');
            
            const badge = document.getElementById('resultBadge');
            if (fails.length > 0) {
                badge.textContent = 'NO-GO';
                badge.className = 'inline-block px-8 py-4 rounded-lg text-2xl font-bold mb-4 bg-red-600 text-white';
            } else if (warns.length > 0) {
                badge.textContent = 'GO (Needs Fixes)';
                badge.className = 'inline-block px-8 py-4 rounded-lg text-2xl font-bold mb-4 bg-yellow-600 text-black';
            } else {
                badge.textContent = 'GO';
                badge.className = 'inline-block px-8 py-4 rounded-lg text-2xl font-bold mb-4 bg-green-600 text-white';
            }

            let reasonsHTML = '';
            if (fails.length > 0) {
                reasonsHTML += '<div class="bg-red-900/30 border border-red-700 rounded p-4 mb-4"><h4 class="text-red-400 font-bold mb-2">Failed Rules:</h4><ul class="list-disc list-inside text-gray-300">';
                fails.forEach(f => reasonsHTML += `<li>${f}</li>`);
                reasonsHTML += '</ul></div>';
            }
            if (warns.length > 0) {
                reasonsHTML += '<div class="bg-yellow-900/30 border border-yellow-700 rounded p-4"><h4 class="text-yellow-400 font-bold mb-2">Warnings:</h4><ul class="list-disc list-inside text-gray-300">';
                warns.forEach(w => reasonsHTML += `<li>${w}</li>`);
                reasonsHTML += '</ul></div>';
            }
            document.getElementById('reasonsList').innerHTML = reasonsHTML;

            document.getElementById('resCashFlow').textContent = '$' + cashFlow.toFixed(0);
            document.getElementById('resCashFlow').className = 'text-2xl font-bold ' + (cashFlow >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('resDSCR').textContent = dscr.toFixed(2);
            document.getElementById('resDSCR').className = 'text-2xl font-bold ' + (dscr >= ruleDSCR ? 'text-green-400' : 'text-red-400');
            document.getElementById('resCOC').textContent = coc.toFixed(1) + '%';
            document.getElementById('resCOC').className = 'text-2xl font-bold ' + (coc >= ruleCOC ? 'text-green-400' : 'text-yellow-400');

            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        updateCalculations();
    </script>
    <script src="js/main.js"></script>
</body>
</html>
